<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Robotics 10 Exam</title>
    <!-- Tailwind CSS (CDN for standalone file) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Poppins', sans-serif; background-color: #f0f4f8; color: #1e293b; }
        .quiz-container { width: 100%; height: 100%; display: flex; flex-direction: column; background-color: white; overflow-y: auto; }
        .active-press:active { transform: translateY(1px); filter: brightness(95%); }
        .option-btn.correct { background-color: #dcfce7 !important; border-color: #16a34a !important; color: #14532d; }
        .option-btn.incorrect { background-color: #fee2e2 !important; border-color: #dc2626 !important; color: #7f1d1d; }
        /* SVG Timer Animation */
        .timer-ring { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear; }
        /* Mirror camera feed for selfie mode */
        #camera-feed { transform: scaleX(-1); }
    </style>
</head>
<body class="flex items-center justify-center">

    <div id="quiz-container" class="quiz-container">
        
        <!-- SCREEN 1: HOLDING / COUNTDOWN -->
        <div id="holding-screen" class="flex flex-col items-center justify-center h-full text-center p-6">
            <h1 id="holding-title" class="text-3xl sm:text-4xl font-bold text-slate-800 mb-4">Robotics 10 Final Exam</h1>
            <div id="countdown-timer" class="text-center w-full">
                <p id="holding-message" class="text-lg sm:text-xl text-slate-600 mb-4">The exam will begin in:</p>
                <div class="text-4xl sm:text-5xl font-bold text-indigo-600 flex justify-center gap-2">
                    <div class="flex flex-col"><span id="days">00</span><span class="text-xs font-normal text-slate-400">Days</span></div> :
                    <div class="flex flex-col"><span id="hours">00</span><span class="text-xs font-normal text-slate-400">Hrs</span></div> :
                    <div class="flex flex-col"><span id="minutes">00</span><span class="text-xs font-normal text-slate-400">Mins</span></div> :
                    <div class="flex flex-col"><span id="seconds">00</span><span class="text-xs font-normal text-slate-400">Secs</span></div>
                </div>
            </div>
            <p id="loading-status-holding" class="text-sm text-slate-500 mt-6 h-auto min-h-[1.25rem] px-4 font-medium animate-pulse">Loading exam schedule...</p>
        </div>

        <!-- SCREEN 2: VERIFICATION -->
        <div id="start-screen" class="hidden flex-col items-center justify-center h-full text-center p-6 bg-white">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800 mb-2">Robotics 10 Final Exam</h1>
            <p class="text-base sm:text-lg text-slate-500 mb-6">Verify your identity to begin.</p>
            
            <div class="flex flex-col items-center gap-6 w-full max-w-md">
                <!-- Name Input -->
                <div class="w-full text-left">
                    <label for="student-name-input" class="font-semibold mb-2 block text-slate-700">Full Name</label>
                    <input type="text" id="student-name-input" placeholder="e.g., Juan Dela Cruz" class="w-full text-lg p-3 border-2 border-slate-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 outline-none transition-colors">
                </div>

                <!-- Camera/Photo Section -->
                <div class="flex flex-col items-center w-full">
                    <div id="camera-view" class="">
                        <div class="w-40 h-40 rounded-full bg-slate-100 overflow-hidden border-4 border-slate-300 flex items-center justify-center relative shadow-inner">
                            <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline muted></video>
                            <canvas id="photo-canvas" class="hidden"></canvas>
                        </div>
                        <p id="camera-status" class="text-sm text-slate-500 mt-2 h-5">Initializing camera...</p>
                    </div>

                    <div id="upload-view" class="hidden">
                        <label for="photo-upload" class="cursor-pointer block">
                            <div class="w-40 h-40 rounded-full bg-slate-100 overflow-hidden border-4 border-slate-300 flex items-center justify-center hover:bg-slate-200 transition-colors shadow-inner">
                                <img id="photo-preview" class="w-full h-full object-cover hidden" alt="Photo Preview">
                                <div id="upload-placeholder" class="flex flex-col items-center text-slate-400">
                                    <svg class="w-10 h-10 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                    <span class="text-xs font-semibold">Tap to Upload</span>
                                </div>
                            </div>
                        </label>
                        <input type="file" id="photo-upload" class="hidden" accept="image/*">
                         <p id="upload-status" class="text-sm text-slate-500 mt-2 h-5">No file selected</p>
                    </div>
                    
                    <button id="toggle-mode-btn" class="mt-2 text-indigo-600 text-sm font-semibold hover:text-indigo-800 transition-colors underline decoration-2 underline-offset-2">
                        Switch to Upload Mode
                    </button>
                </div>
            </div>

            <!-- Start Button -->
            <button id="start-btn" class="bg-indigo-600 active-press hover:bg-indigo-700 w-full max-w-md text-white font-bold py-4 px-12 text-xl rounded-xl transition-all mt-8 disabled:bg-slate-300 disabled:text-slate-500 disabled:cursor-not-allowed shadow-lg disabled:shadow-none transform transition-transform" disabled>
                Start Exam
            </button>
            <p id="loading-status" class="text-sm text-slate-500 mt-3 h-5 font-medium">Checking system readiness...</p>
        </div>

        <!-- SCREEN 3: MAIN EXAM -->
        <div id="main-quiz" class="hidden h-full flex flex-col p-4 sm:p-6 bg-slate-50">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-slate-500 tracking-wide uppercase">Question</h2>
                <div id="quiz-question-counter" class="text-sm font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100">1 / 30</div>
            </div>
            
            <div class="flex-grow flex flex-col items-center w-full max-w-2xl mx-auto">
                <!-- Timer Ring -->
                 <div class="relative w-24 h-24 mb-6">
                    <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-slate-200" stroke-width="6" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        <circle id="quiz-timer-ring" class="text-indigo-500 timer-ring" stroke-width="6" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" style="transform: rotate(-90deg); transform-origin: 50% 50%;" />
                    </svg>
                    <div id="quiz-timer-text" class="absolute inset-0 flex items-center justify-center text-3xl font-bold text-slate-700">45</div>
                </div>

                <!-- Question Card -->
                <div class="w-full bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6 min-h-[150px] flex items-center justify-center">
                    <p id="quiz-question-text" class="text-lg sm:text-xl font-medium text-slate-800 text-center leading-relaxed"></p>
                </div>

                <!-- Options -->
                <div id="quiz-options-container" class="grid grid-cols-1 gap-3 w-full">
                    <!-- Buttons generated by JS -->
                </div>
            </div>
        </div>

        <!-- SCREEN 4: RESULTS -->
        <div id="quiz-results-screen" class="hidden h-full flex-grow flex-col items-center justify-center text-center p-6 bg-white">
            <h2 class="text-3xl sm:text-4xl font-bold text-indigo-600 mb-6">Exam Complete!</h2>
            
            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-8 mb-6 w-full max-w-md flex flex-col items-center shadow-sm">
                <div class="relative mb-4">
                    <img id="student-photo" src="" alt="Student Photo" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-md">
                    <div class="absolute bottom-0 right-0 bg-indigo-500 text-white p-2 rounded-full border-2 border-white">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                </div>
                
                <p id="student-name-display" class="text-xl font-bold text-slate-800 mb-1"></p>
                <p class="text-sm text-slate-500 mb-6 uppercase tracking-wider font-semibold">Student</p>
                
                <div class="w-full border-t border-slate-200 pt-6">
                    <p class="text-slate-600 mb-1">Final Score</p>
                    <p id="quiz-score-text" class="text-5xl font-bold text-indigo-600">0 / 30</p>
                </div>
            </div>

            <p id="submission-status" class="text-base font-semibold mb-6 h-6 animate-pulse text-indigo-600">Submitting results...</p>
            
            <div id="results-buttons" class="flex flex-col gap-3 w-full max-w-md">
                 <button id="quiz-restart-btn" class="w-full active-press bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 text-lg rounded-xl transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Finish & Play Again
                 </button>
            </div>
            
            <button id="manual-retry-btn" class="hidden w-full max-w-md mt-4 active-press bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-xl transition-colors shadow-md">
                Retry Submission
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            // PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxCdsaRYx6OWCA3ogked3DJDbl3pFQfqIj-nNxnXD7Ooc38Btb4CXWrDkj4r7Zlx8pSaQ/exec'; 
            
            // --- CONSTANTS ---
            const TIME_LIMIT = 45; // Seconds per question
            
            // --- DOM ELEMENTS ---
            const holdingScreen = document.getElementById('holding-screen');
            const countdownTimerEl = document.getElementById('countdown-timer');
            const loadingStatusHoldingEl = document.getElementById('loading-status-holding');
            const holdingMessage = document.getElementById('holding-message');
            
            const startScreen = document.getElementById('start-screen');
            const studentNameInput = document.getElementById('student-name-input');
            const startBtn = document.getElementById('start-btn');
            const loadingStatusEl = document.getElementById('loading-status');
            
            const cameraView = document.getElementById('camera-view');
            const cameraFeed = document.getElementById('camera-feed');
            const photoCanvas = document.getElementById('photo-canvas');
            const cameraStatus = document.getElementById('camera-status');
            
            const uploadView = document.getElementById('upload-view');
            const photoUploadInput = document.getElementById('photo-upload');
            const photoPreview = document.getElementById('photo-preview');
            const uploadPlaceholder = document.getElementById('upload-placeholder');
            const uploadStatus = document.getElementById('upload-status');
            const toggleModeBtn = document.getElementById('toggle-mode-btn');
            
            const mainQuiz = document.getElementById('main-quiz');
            const quizQuestionCounterEl = document.getElementById('quiz-question-counter');
            const quizQuestionTextEl = document.getElementById('quiz-question-text');
            const quizOptionsContainerEl = document.getElementById('quiz-options-container');
            const quizTimerTextEl = document.getElementById('quiz-timer-text');
            const quizTimerRingEl = document.getElementById('quiz-timer-ring');
            
            const quizResultsScreenEl = document.getElementById('quiz-results-screen');
            const studentPhotoEl = document.getElementById('student-photo');
            const studentNameDisplayEl = document.getElementById('student-name-display');
            const quizScoreTextEl = document.getElementById('quiz-score-text');
            const submissionStatusEl = document.getElementById('submission-status');
            const restartBtn = document.getElementById('quiz-restart-btn');
            const manualRetryBtn = document.getElementById('manual-retry-btn');

            // --- STATE VARIABLES ---
            let examData = [];
            let isExamDataReady = false;
            let captureMode = 'camera'; // 'camera' or 'upload'
            let cameraStream = null;
            let currentIndex = 0;
            let score = 0;
            let timerInterval;
            let timeLeft = TIME_LIMIT;
            let studentName = '';
            let studentPhotoData = '';
            let examStartTimeStamp = null;
            let examFinishTimeStamp = null;
            let countdownInterval;
            let replays = 0; // Not used in display but kept for backend compatibility

            // --- UTILS ---
            const shuffle = (arr) => arr.map(value => ({ value, sort: Math.random() })).sort((a, b) => a.sort - b.sort).map(({ value }) => value);
            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // --- INIT ---
            async function fetchExamConfigAndData() {
                try {
                    if (!GOOGLE_SCRIPT_URL) {
                        throw new Error("CONFIGURATION ERROR: The GOOGLE_SCRIPT_URL is empty in the HTML file.");
                    }
                    
                    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getExam`);
                    if (!response.ok) throw new Error("NETWORK ERROR: Could not connect to the Google Script.");
                    
                    const result = await response.json();
                    if (result.error) throw new Error(result.error);
                    
                    // 1. Decode Data (Base64 -> String -> JSON)
                    if (!result.data) throw new Error("Server returned empty data.");
                    const decodedString = atob(result.data);
                    examData = JSON.parse(decodedString);
                    isExamDataReady = true;

                    // 2. Schedule Logic
                    const startTime = new Date(result.startTime);
                    const endTime = new Date(result.endTime);
                    
                    if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                        throw new Error("SCHEDULE ERROR: Invalid date format from Config sheet.");
                    }

                    // Update UI success state
                    loadingStatusHoldingEl.textContent = 'Data loaded. checking schedule...';
                    loadingStatusHoldingEl.classList.remove('animate-pulse');
                    loadingStatusEl.textContent = '✅ Exam ready!';
                    loadingStatusEl.className = 'text-sm text-green-600 mt-3 h-5 font-bold';
                    
                    checkExamAvailability(startTime, endTime);
                    checkStartButtonState();

                } catch (error) {
                    console.error(error);
                    handleCriticalError(error.message);
                }
            }

            function handleCriticalError(msg) {
                holdingScreen.classList.remove('hidden');
                startScreen.classList.add('hidden');
                countdownTimerEl.classList.add('hidden');
                
                holdingMessage.textContent = msg;
                holdingMessage.className = "text-red-600 font-bold px-4";
                
                loadingStatusHoldingEl.textContent = "Please resolve the issue and refresh.";
                loadingStatusHoldingEl.className = "text-red-500 font-medium";
                loadingStatusEl.textContent = "Error loading exam.";
                loadingStatusEl.className = "text-sm text-red-600 mt-3 h-5 font-bold";
            }

            function checkExamAvailability(startTime, endTime) {
                const now = new Date();
                
                if (now < startTime) {
                    // BEFORE EXAM
                    holdingScreen.classList.remove('hidden');
                    startScreen.classList.add('hidden');
                    updateCountdown(startTime.getTime());
                    countdownInterval = setInterval(() => updateCountdown(startTime.getTime()), 1000);
                } else if (now > endTime) {
                    // AFTER EXAM (EXPIRED)
                    holdingScreen.classList.remove('hidden');
                    startScreen.classList.add('hidden');
                    countdownTimerEl.classList.add('hidden');
                    holdingMessage.textContent = 'This exam has expired.';
                    holdingMessage.className = 'text-xl font-bold text-red-600 mb-2';
                    loadingStatusHoldingEl.textContent = 'Please contact your teacher for assistance.';
                    loadingStatusHoldingEl.className = 'text-slate-500 font-medium';
                } else {
                    // ACTIVE EXAM
                    transitionToStartScreen();
                }
            }

            function updateCountdown(targetTime) {
                const now = new Date().getTime();
                const distance = targetTime - now;
                
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    transitionToStartScreen();
                    return;
                }
                
                const d = Math.floor(distance / (1000 * 60 * 60 * 24));
                const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((distance % (1000 * 60)) / 1000);
                
                document.getElementById('days').textContent = String(d).padStart(2, '0');
                document.getElementById('hours').textContent = String(h).padStart(2, '0');
                document.getElementById('minutes').textContent = String(m).padStart(2, '0');
                document.getElementById('seconds').textContent = String(s).padStart(2, '0');
            }

            function transitionToStartScreen() {
                clearInterval(countdownInterval);
                holdingScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
                startScreen.classList.add('flex');
                setupCamera();
            }

            // --- CAMERA & UPLOAD LOGIC ---
            async function setupCamera() {
                if (captureMode !== 'camera') return;
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    cameraStatus.textContent = "Camera API not supported.";
                    cameraStatus.className = "text-sm text-red-500 mt-2 h-5 font-medium";
                    return;
                }
                
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                    cameraFeed.srcObject = cameraStream;
                    cameraStatus.textContent = "Camera active.";
                    cameraStatus.className = "text-sm text-green-600 mt-2 h-5 font-medium";
                    checkStartButtonState();
                } catch (err) {
                    console.error("Camera Error:", err);
                    cameraStatus.textContent = "Access denied. Try upload mode.";
                    cameraStatus.className = "text-sm text-red-500 mt-2 h-5 font-medium";
                }
            }

            function stopCamera() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
            }

            function toggleCaptureMode() {
                if (captureMode === 'camera') {
                    // Switch to Upload
                    captureMode = 'upload';
                    stopCamera();
                    cameraView.classList.add('hidden');
                    uploadView.classList.remove('hidden');
                    toggleModeBtn.textContent = "Switch to Camera Mode";
                    checkStartButtonState();
                } else {
                    // Switch to Camera
                    captureMode = 'camera';
                    studentPhotoData = ''; // Reset upload data
                    uploadView.classList.add('hidden');
                    cameraView.classList.remove('hidden');
                    toggleModeBtn.textContent = "Switch to Upload Mode";
                    setupCamera();
                }
            }

            function handlePhotoUpload(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        studentPhotoData = evt.target.result;
                        photoPreview.src = studentPhotoData;
                        photoPreview.classList.remove('hidden');
                        uploadPlaceholder.classList.add('hidden');
                        uploadStatus.textContent = "Photo loaded.";
                        uploadStatus.className = "text-sm text-green-600 mt-2 h-5 font-medium";
                        checkStartButtonState();
                    };
                    reader.readAsDataURL(file);
                }
            }

            function checkStartButtonState() {
                const hasName = studentNameInput.value.trim().length > 0;
                let hasPhoto = false;
                
                if (captureMode === 'camera') {
                    hasPhoto = !!cameraStream && cameraStream.active;
                } else {
                    hasPhoto = !!studentPhotoData;
                }
                
                if (hasName && hasPhoto && isExamDataReady) {
                    startBtn.disabled = false;
                    startBtn.classList.remove('shadow-none');
                    startBtn.classList.add('shadow-lg');
                } else {
                    startBtn.disabled = true;
                    startBtn.classList.add('shadow-none');
                    startBtn.classList.remove('shadow-lg');
                }
            }

            // --- EXAM LOGIC ---
            function startExam() {
                // Capture Name & Photo
                studentName = studentNameInput.value.trim();
                examStartTimeStamp = new Date().toISOString();
                
                if (captureMode === 'camera') {
                    if (!cameraStream) return;
                    const ctx = photoCanvas.getContext('2d');
                    photoCanvas.width = cameraFeed.videoWidth;
                    photoCanvas.height = cameraFeed.videoHeight;
                    // Mirror context to match video css transform
                    ctx.translate(photoCanvas.width, 0);
                    ctx.scale(-1, 1);
                    ctx.drawImage(cameraFeed, 0, 0);
                    studentPhotoData = photoCanvas.toDataURL('image/jpeg', 0.8);
                    stopCamera();
                }
                
                // Transition
                startScreen.classList.remove('flex');
                startScreen.classList.add('hidden');
                mainQuiz.classList.remove('hidden');
                mainQuiz.classList.add('flex');
                
                currentIndex = 0;
                score = 0;
                showQuestion();
            }

            function showQuestion() {
                // Reset Timer UI
                clearInterval(timerInterval);
                timeLeft = TIME_LIMIT;
                quizTimerTextEl.textContent = timeLeft;
                quizTimerRingEl.style.strokeDashoffset = '283'; // Reset ring
                quizTimerRingEl.classList.remove('text-red-500', 'text-orange-500');
                quizTimerRingEl.classList.add('text-indigo-500');
                
                // Content
                const q = examData[currentIndex];
                quizQuestionCounterEl.textContent = `${currentIndex + 1} / ${examData.length}`;
                quizQuestionTextEl.textContent = q.question;
                
                // Options
                quizOptionsContainerEl.innerHTML = '';
                const shuffledOptions = shuffle([...q.options]);
                
                shuffledOptions.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "option-btn w-full p-4 text-left border-2 border-slate-200 rounded-xl bg-white hover:border-indigo-300 hover:bg-slate-50 transition-all font-medium text-slate-700 active-press disabled:cursor-not-allowed";
                    btn.textContent = opt;
                    btn.onclick = () => handleAnswer(btn, opt, q.answer);
                    quizOptionsContainerEl.appendChild(btn);
                });
                
                startTimer();
            }

            function startTimer() {
                const totalDash = 283;
                timerInterval = setInterval(() => {
                    timeLeft--;
                    quizTimerTextEl.textContent = timeLeft;
                    
                    // Ring Animation
                    const offset = totalDash - (timeLeft / TIME_LIMIT) * totalDash;
                    quizTimerRingEl.style.strokeDashoffset = offset;
                    
                    // Color Warning
                    if (timeLeft <= 15) {
                        quizTimerRingEl.classList.remove('text-indigo-500');
                        quizTimerRingEl.classList.add('text-orange-500');
                    }
                    if (timeLeft <= 5) {
                        quizTimerRingEl.classList.remove('text-orange-500');
                        quizTimerRingEl.classList.add('text-red-500');
                    }
                    
                    if (timeLeft <= 0) {
                        handleTimeout();
                    }
                }, 1000);
            }

            function handleTimeout() {
                clearInterval(timerInterval);
                disableOptions();
                // Treat as incorrect, wait, then next
                setTimeout(nextQuestion, 1500);
            }

            function handleAnswer(btn, selected, correct) {
                clearInterval(timerInterval);
                disableOptions();
                
                // Track score silently
                if (selected === correct) {
                    score++;
                }
                
                // Visual confirmation of selection (Neutral - No Red/Green)
                // Highlight the selected answer in a neutral color (Indigo/Slate)
                btn.classList.remove('bg-white');
                btn.classList.add('bg-indigo-50', 'border-indigo-300', 'text-indigo-800');
                
                // Proceed slightly faster since there's no feedback to read
                setTimeout(nextQuestion, 1000);
            }

            function disableOptions() {
                const btns = quizOptionsContainerEl.querySelectorAll('button');
                btns.forEach(b => b.disabled = true);
            }

            function nextQuestion() {
                currentIndex++;
                if (currentIndex < examData.length) {
                    showQuestion();
                } else {
                    finishExam();
                }
            }

            // --- RESULTS & SUBMISSION ---
            function finishExam() {
                examFinishTimeStamp = new Date().toISOString();
                mainQuiz.classList.remove('flex');
                mainQuiz.classList.add('hidden');
                
                quizResultsScreenEl.classList.remove('hidden');
                quizResultsScreenEl.classList.add('flex');
                
                studentNameDisplayEl.textContent = studentName;
                studentPhotoEl.src = studentPhotoData;
                quizScoreTextEl.textContent = `${score} / ${examData.length}`;
                
                attemptSubmission();
            }

            async function attemptSubmission() {
                manualRetryBtn.classList.add('hidden');
                restartBtn.disabled = true;
                
                const formData = new FormData();
                formData.append('studentName', studentName);
                formData.append('score', `${score} / ${examData.length}`);
                formData.append('replayCount', replays);
                formData.append('startTime', examStartTimeStamp);
                formData.append('finishTime', examFinishTimeStamp);
                formData.append('photoData', studentPhotoData);

                let attempts = 0;
                const maxAttempts = 3;
                
                const tryPost = async () => {
                    attempts++;
                    submissionStatusEl.textContent = `Submitting results... (Attempt ${attempts}/${maxAttempts})`;
                    submissionStatusEl.className = "text-base font-semibold mb-6 h-6 animate-pulse text-indigo-600";
                    
                    try {
                        const response = await fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        if (data.result === 'success') {
                            submissionStatusEl.textContent = "✅ Results saved successfully!";
                            submissionStatusEl.className = "text-base font-bold mb-6 h-6 text-green-600";
                            restartBtn.disabled = false;
                            restartBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        } else {
                            throw new Error(data.error || "Unknown server error");
                        }
                    } catch (e) {
                        console.error("Submission failed:", e);
                        if (attempts < maxAttempts) {
                            await sleep(3000);
                            await tryPost();
                        } else {
                            submissionStatusEl.textContent = "❌ Submission failed.";
                            submissionStatusEl.className = "text-base font-bold mb-6 h-6 text-red-600";
                            manualRetryBtn.classList.remove('hidden');
                            // Allow restart even if failed, so student isn't stuck
                            restartBtn.disabled = false;
                            restartBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                };
                
                await tryPost();
            }

            // --- EVENT LISTENERS ---
            studentNameInput.addEventListener('input', checkStartButtonState);
            toggleModeBtn.addEventListener('click', toggleCaptureMode);
            photoUploadInput.addEventListener('change', handlePhotoUpload);
            startBtn.addEventListener('click', startExam);
            manualRetryBtn.addEventListener('click', attemptSubmission);
            restartBtn.addEventListener('click', () => location.reload());

            // --- BOOTSTRAP ---
            fetchExamConfigAndData();
        });
    </script>
</body>
</html>
